<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Archive Search :: Institute for Precedent Studies Archive</title>
  <link rel="icon" type="image/svg+xml" href="/canonical_brutalist_diskette.svg">
  <link rel="stylesheet" href="css/archive.css">
  <script src="js/db-service.js" defer></script>
  <script src="js/components.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>

  <div class="container">

    <!-- BREADCRUMB NAVIGATION -->
    <tg-breadcrumb>
      <a href="index.html">Archive Access</a>
      <span>Search</span>
    </tg-breadcrumb>

    <!-- PAGE HEADER -->
    <tg-box header="Archive Search">
      <p class="text-secondary meta mt-3">Query the institutional archive database. Search across all recovered text,
        metadata, and phenomenological markers.</p>
    </tg-box>

    <!-- SEARCH FORM -->
    <tg-box variant="secondary" header="Query Parameters">
      <form id="search-form">
        <!-- DATABASE TARGET -->
        <div class="form-group">
          <label class="form-label">Database Target</label>
          <div style="display: flex; gap: var(--space-4);">
            <label class="filter-option">
              <input type="radio" name="target" class="form-checkbox" value="cases" checked>
              <span class="form-checkbox-label">Institutional Cases</span>
            </label>
            <label class="filter-option">
              <input type="radio" name="target" class="form-checkbox" value="fragments">
              <span class="form-checkbox-label">Raw Data Fragments</span>
            </label>
          </div>
        </div>

        <!-- TEXT SEARCH -->
        <div class="form-group">
          <label for="search-query" class="form-label">Search Terms</label>
          <input type="text" id="search-query" class="form-input" placeholder="Enter query string...">
        </div>

        <!-- PHENOMENOLOGY FILTER -->
        <div class="form-group">
          <label for="phenomenology-select" class="form-label">Phenomenological Pattern</label>
          <select id="phenomenology-select" class="form-select">
            <option value="">All Patterns</option>
            <option value="pattern-a">Pattern Alpha (Systemic Stillness)</option>
            <option value="pattern-b">Pattern Beta (Structural Fracture)</option>
            <option value="pattern-c">Pattern Gamma (Cognitive Invalidation)</option>
            <option value="pre-inst">Pre-Institutional (Silent Age)</option>
            <option value="unknown">Unclassifiable</option>
          </select>
        </div>

        <!-- EPISTEMIC FILTER -->
        <div class="form-group">
          <label for="epistemic-select" class="form-label">Epistemic Status</label>
          <select id="epistemic-select" class="form-select">
            <option value="">All Statuses</option>
            <option value="primary">Primary Source / Testimony</option>
            <option value="secondary">Secondary / Institutional Log</option>
            <option value="reconstructed">Partial Reconstruction</option>
            <option value="contested">Contested Analysis</option>
          </select>
        </div>

        <!-- DATE RANGE -->
        <div class="form-group">
          <label class="form-label">Estimated Epoch Range</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-2);">
            <input type="text" class="form-input" placeholder="From (e.g. 10,000 AI)">
            <input type="text" class="form-input" placeholder="To (e.g. 14,847 PI)">
          </div>
        </div>

        <!-- SEARCH BUTTONS -->
        <div style="display: flex; gap: var(--space-2); margin-top: var(--space-4);">
          <button type="submit" class="btn">Execute Query</button>
          <button type="reset" class="btn">Clear Parameters</button>
        </div>
      </form>
    </tg-box>

    <!-- SEARCH RESULTS (shown after query) -->
    <tg-box header="Query Results">
      <div id="search-stats" class="metadata-grid mb-4 meta" style="display: none;">
        <div class="metadata-grid__row">
          <div class="metadata-grid__label">Query:</div>
          <div id="stat-query" class="metadata-grid__value">-</div>
        </div>
        <div class="metadata-grid__row">
          <div class="metadata-grid__label">Results:</div>
          <div id="stat-count" class="metadata-grid__value">0 documents found</div>
        </div>
      </div>

      <div id="search-results-container">
        <div class="meta">Awaiting query execution...</div>
      </div>
    </tg-box>

    <!-- ADVANCED SEARCH NOTICE -->
    <div class="advisory">
      <div class="advisory__header">Advanced Query Syntax</div>
      <div class="advisory__content">
        <p>The archive search supports Boolean operators and field-specific queries:</p>
        <ul class="meta"
          style="margin-left: var(--space-3); margin-top: var(--space-2); line-height: var(--line-height-relaxed);">
          <li><code>AND, OR, NOT</code> - Boolean operators</li>
          <li><code>"exact phrase"</code> - Phrase matching</li>
          <li><code>pattern:alpha</code> - Phenomenological grouping</li>
          <li><code>epoch:pi</code> - Temporal filtering</li>
          <li><code>status:primary</code> - Epistemic status</li>
        </ul>
      </div>
    </div>

    <!-- FOOTER -->
    <tg-footer mode="Search Intelligence"></tg-footer>

  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const form = document.getElementById('search-form');
      const resultsContainer = document.getElementById('search-results-container');
      const stats = document.getElementById('search-stats');
      const statQuery = document.getElementById('stat-query');
      const statCount = document.getElementById('stat-count');

      // Wait for database service to be registered on window
      let retries = 0;
      while (!window.IPS_DB && retries < 100) {
        await new Promise(r => setTimeout(r, 60));
        retries++;
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const query = document.getElementById('search-query').value;
        const target = form.querySelector('input[name="target"]:checked').value;

        resultsContainer.innerHTML = '<div class="meta">Executing stratigraphic query...</div>';
        stats.style.display = 'block';
        statQuery.textContent = `"${query || '*'}" [TARGET: ${target}]`;

        try {
          const results = await window.IPS_DB.search(query);
          statCount.textContent = `${results.length} documents found`;

          if (results.length === 0) {
            resultsContainer.innerHTML = '<div class="meta">No records matching criteria located in current strata.</div>';
          } else {
            resultsContainer.innerHTML = results.map(r => `
              <div class="document-card">
                <div class="document-card__id">${r.fragment_id}</div>
                <h2 class="document-card__title">
                  <a href="case-view.html?id=${r.fragment_id}" class="document-card__title-link">${r.title}</a>
                </h2>
                <div class="document-card__actions">
                  <a href="case-view.html?id=${r.fragment_id}" class="btn btn--small">Access Document</a>
                </div>
              </div>
            `).join('');
          }
        } catch (err) {
          resultsContainer.innerHTML = `<div class="advisory advisory--red"><div class="advisory__header">QUERY FAILED</div><div class="advisory__content">${err.message}</div></div>`;
        }
      });
    });
  </script>
</body>

</html>